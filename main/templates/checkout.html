{% extends 'base.html' %}
{% load static %}

{% block title %}Оформление заказа - MPTCOURSE{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/home.css' %}">
<link rel="stylesheet" href="{% static 'css/checkout.css' %}">
{% endblock %}

{% block content %}
<div class="checkout-content">
    <div class="checkout-header">
        <h1>Оформление заказа</h1>
        <a href="{% url 'cart' %}">← Вернуться в корзину</a>
    </div>

    <form method="post" class="checkout-container" id="checkout-form" onsubmit="return false;">
        {% csrf_token %}
        <input type="hidden" name="saved_payment_id" id="saved_payment_id_input" value="">
        <input type="hidden" name="address_id" value="">

        <!-- Левая колонка - Форма -->
        <div class="checkout-form">
            <!-- Способ оплаты -->
            <div class="form-section">
                <h2>Способ оплаты</h2>
                <div class="radio-item" style="margin-bottom: 12px;">
                    <input type="radio" name="payment_method" id="payment_sbp" value="sbp" checked>
                    <label for="payment_sbp">
                        <div><strong>СБП</strong></div>
                        <div class="radio-item-info">Оплата через Систему быстрых платежей</div>
                    </label>
                </div>
                <div style="text-align: center; margin: 16px 0; color: var(--text-color-secondary);">или</div>

                {% if user_balance > 0 %}
                <div class="radio-item" style="margin-bottom: 12px;">
                    <input type="radio" name="payment_method" id="payment_balance" value="balance" {% if user_balance >= cart.total_price %}{% else %}disabled{% endif %}>
                    <label for="payment_balance">
                        <div><strong>Личный счёт</strong></div>
                        <div class="radio-item-info">Баланс: <strong>{{ user_balance }} ₽</strong>{% if user_balance < cart.total_price %}<span style="color: var(--text-color-secondary);"> (Недостаточно средств)</span>{% endif %}</div>
                    </label>
                </div>
                <div style="text-align: center; margin: 16px 0; color: var(--text-color-secondary);">или</div>
                {% endif %}

                {% if saved_payments %}
                <div class="radio-group" style="margin-bottom: 20px;">
                    {% for payment in saved_payments %}
                    <div class="radio-item" data-card-balance="{{ payment.balance }}" data-card-id="{{ payment.id }}">
                        <input type="radio" name="payment_method" id="saved_payment_{{ payment.id }}" value="card" data-saved-id="{{ payment.id }}">
                        <label for="saved_payment_{{ payment.id }}">
                            <div><strong>{{ payment.card_type|upper|default:"CARD" }} {{ payment.mask_card_number }}</strong></div>
                            <div class="radio-item-info">
                                Баланс: <strong>{{ payment.balance }} ₽</strong>
                                {% if payment.is_default %} (Основной){% endif %}
                                <span class="insufficient-funds" style="color: var(--text-color-secondary); display: none;"> (Недостаточно средств)</span>
                            </div>
                        </label>
                    </div>
                    {% endfor %}
                </div>
                <div style="text-align: center; margin: 16px 0; color: var(--text-color-secondary);">или</div>
                {% endif %}

                <div class="radio-item">
                    <input type="radio" name="payment_method" id="new_payment" value="card">
                    <label for="new_payment"><strong>Новая карта</strong></label>
                </div>

                <div id="new-card-form" style="margin-top: 16px; {% if saved_payments %}display: none;{% endif %}">
                    <div class="form-group">
                        <label for="card_number">Номер карты *</label>
                        <input type="text" id="card_number" name="card_number" placeholder="1234 5678 9012 3456" maxlength="19" pattern="[0-9\s]+" {% if not saved_payments %}required{% endif %}>
                    </div>
                    <div class="form-group">
                        <label for="card_holder_name">Имя держателя карты *</label>
                        <input type="text" id="card_holder_name" name="card_holder_name" placeholder="IVAN IVANOV" {% if not saved_payments %}required{% endif %}>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="expiry_month">Месяц *</label>
                            <input type="text" id="expiry_month" name="expiry_month" placeholder="MM" maxlength="2" pattern="[0-9]{2}" {% if not saved_payments %}required{% endif %}>
                        </div>
                        <div class="form-group">
                            <label for="expiry_year">Год *</label>
                            <input type="text" id="expiry_year" name="expiry_year" placeholder="YYYY" maxlength="4" pattern="[0-9]{4}" {% if not saved_payments %}required{% endif %}>
                        </div>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="save_card" name="save_card">
                        <label for="save_card">Сохранить данные карты для следующих покупок</label>
                    </div>
                </div>
            </div>

            <!-- Промокод -->
            <div class="form-section">
                <h2>Промокод</h2>
                <div class="form-group" style="margin-bottom: 16px;">
                    <label for="promo_code_input">Введите промокод</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="promo_code_input" name="promo_code_input" placeholder="Введите промокод" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        <button type="button" id="apply_promo_btn" style="padding: 10px 20px; background: var(--text-color); color: var(--bg-color); border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">Применить</button>
                    </div>
                </div>
                <div id="promo_message" style="margin-top:8px; font-size:12px; color: var(--text-color); display:none;"></div>
                
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd;">
                    <h3 style="font-size: 14px; margin-bottom: 12px; color: var(--text-color-secondary);">Доступные промокоды:</h3>
                    <div id="promotions-container">
                        <div id="promotions-loading" style="text-align: center; padding: 20px; color: var(--text-color-secondary);">
                            Загрузка промокодов...
                        </div>
                        <div id="promotions-list" style="display: none;"></div>
                        <div id="promotions-empty" style="display: none; text-align: center; padding: 20px; color: var(--text-color-secondary);">
                            Нет доступных промокодов
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Правая колонка - Итоговая информация -->
        <div class="checkout-summary">
            <h2>Итого</h2>

            <div class="cart-items-summary">
                {% for item in cart.items.all %}
                {% if item.course %}
                <div class="cart-item-summary">
                    {% if item.course.main_image_url %}
                    <img src="{{ item.course.main_image_url }}" alt="{{ item.course.title }}" class="cart-item-image">
                    {% else %}
                    <div class="cart-item-image" style="display: flex; align-items: center; justify-content: center; color: var(--text-color-secondary); font-size: 10px;">Курс</div>
                    {% endif %}
                    <div class="cart-item-info">
                        <div class="cart-item-name">{{ item.course.title }}</div>
                        <div class="cart-item-details">Количество: {{ item.quantity }}</div>
                    </div>
                    <div class="cart-item-price">{{ item.subtotal }} ₽</div>
                </div>
                {% endif %}
                {% endfor %}
            </div>

            <div class="summary-item">
                <span class="summary-item-label">Товары:</span>
                <span class="summary-item-value" id="subtotal-value">{{ subtotal }} ₽</span>
            </div>
            <div class="summary-item" id="discount-item" style="display: none;">
                <span class="summary-item-label discount">Скидка:</span>
                <span class="summary-item-value discount" id="discount-value">0 ₽</span>
            </div>
            <div class="summary-item" style="color: var(--text-color-secondary); font-size: 14px;">
                <span class="summary-item-label">Доставка:</span>
                <span class="summary-item-value" id="delivery-value">Не требуется</span>
            </div>
            <div class="summary-item">
                <span class="summary-item-label">НДС {{ vat_rate }}%:</span>
                <span class="summary-item-value" id="vat-value">{{ vat_amount }} ₽</span>
            </div>
            <div class="summary-item total">
                <span class="summary-item-label">Итого:</span>
                <span class="summary-item-value" id="total-value">{{ total_with_vat }} ₽</span>
            </div>

            <button type="submit" class="submit-button">Оформить заказ</button>
        </div>
    </form>
</div>

<script>
// Глобальный обработчик ошибок для отладки
window.addEventListener('error', function(e) {
    console.error('❌ Глобальная ошибка JavaScript:', {
        message: e.message,
        filename: e.filename,
        lineno: e.lineno,
        colno: e.colno,
        error: e.error,
        stack: e.error ? e.error.stack : null
    });
    console.error('Причина ошибки:', e.error ? e.error.toString() : 'Неизвестная ошибка');
    // Не останавливаем выполнение, просто логируем
    return true;
}, true);

// Обработчик для необработанных промисов
window.addEventListener('unhandledrejection', function(e) {
    console.error('❌ Необработанная ошибка Promise:', e.reason);
    console.error('Причина:', e.reason ? e.reason.toString() : 'Неизвестная ошибка');
    if (e.reason && e.reason.stack) {
        console.error('Stack trace:', e.reason.stack);
    }
});

function parseAmount(text) { 
    const cleaned = text.replace(/[^\d.,]/g, ''); 
    return parseFloat(cleaned.replace(',', '.')) || 0; 
}

function formatAmount(amount) { 
    return amount.toFixed(2) + ' ₽'; 
}

function getTotalAmount() {
    try {
        const subtotalEl = document.getElementById('subtotal-value');
        if (!subtotalEl) return 0;
        const subtotalText = subtotalEl.textContent || '0';
    const subtotal = parseAmount(subtotalText);
    const discountItem = document.getElementById('discount-item');
    let discount = 0;
    if (discountItem && discountItem.style.display !== 'none') {
            const discountValueEl = document.getElementById('discount-value');
            if (discountValueEl) {
                const discountText = discountValueEl.textContent || '0';
        discount = parseAmount(discountText);
    }
        }
        const deliveryEl = document.getElementById('delivery-value');
        if (!deliveryEl) return subtotal;
        const deliveryText = deliveryEl.textContent || '0';
    const delivery = parseAmount(deliveryText);
    const amountAfterDiscount = subtotal - discount + delivery; // Товары - скидка + доставка
    const vatRate = 20;
    const vatRounded = Math.round((amountAfterDiscount * vatRate / 100) * 100) / 100;
    const totalRounded = Math.round((amountAfterDiscount + vatRounded) * 100) / 100;
    return totalRounded;
    } catch (e) {
        console.error('Ошибка в getTotalAmount:', e);
        return 0;
    }
}

function calculateTotal() {
    try {
    const totalRounded = getTotalAmount();
    const vatElement = document.getElementById('vat-value');
    const totalElement = document.getElementById('total-value');
    if (vatElement) {
            const subtotalEl = document.getElementById('subtotal-value');
            if (!subtotalEl) return;
            const subtotalText = subtotalEl.textContent || '0';
        const subtotal = parseAmount(subtotalText);
        const discountItem = document.getElementById('discount-item');
        let discount = 0;
        if (discountItem && discountItem.style.display !== 'none') {
                const discountValueEl = document.getElementById('discount-value');
                if (discountValueEl) {
                    const discountText = discountValueEl.textContent || '0';
            discount = parseAmount(discountText);
        }
            }
            const deliveryEl = document.getElementById('delivery-value');
            if (!deliveryEl) return;
            const deliveryText = deliveryEl.textContent || '0';
        const delivery = parseAmount(deliveryText);
        const amountAfterDiscount = subtotal - discount + delivery; // Товары - скидка + доставка
        const vatRate = 20;
        const vatRounded = Math.round((amountAfterDiscount * vatRate / 100) * 100) / 100;
        vatElement.textContent = formatAmount(vatRounded);
    }
    if (totalElement) totalElement.textContent = formatAmount(totalRounded);
    updateCardBalances();
    updateSubmitButton();
    } catch (e) {
        console.error('Ошибка в calculateTotal:', e);
    }
}

function updateCardBalances() {
    try {
    const totalAmount = getTotalAmount();
        const cardItems = document.querySelectorAll('.radio-item[data-card-balance]');
        if (!cardItems || cardItems.length === 0) return;
        
        cardItems.forEach(cardItem => {
            if (!cardItem) return;
            
            try {
                const cardBalanceAttr = cardItem.getAttribute('data-card-balance');
                const cardBalance = parseFloat(cardBalanceAttr) || 0;
        const insufficientFundsSpan = cardItem.querySelector('.insufficient-funds');
        const radioInput = cardItem.querySelector('input[type="radio"]');
        
        if (cardBalance < totalAmount) {
            if (insufficientFundsSpan) insufficientFundsSpan.style.display = 'inline';
            if (radioInput) {
                radioInput.disabled = true;
                if (radioInput.checked) {
                    // Если выбранная карта стала недоступна, переключаем на СБП
                    const sbpRadio = document.getElementById('payment_sbp');
                            if (sbpRadio) {
                                sbpRadio.checked = true;
                                // Не вызываем dispatchEvent, чтобы избежать ошибок
                                // Вместо этого вызываем updateSubmitButton напрямую
                                try {
                                    updateSubmitButton();
                                } catch (e) {
                                    console.error('Ошибка при updateSubmitButton:', e);
                                }
                            }
                }
            }
        } else {
            if (insufficientFundsSpan) insufficientFundsSpan.style.display = 'none';
            if (radioInput) radioInput.disabled = false;
                }
            } catch (e) {
                // Игнорируем ошибки для отдельных элементов
                console.error('Ошибка при обновлении баланса карты:', e);
        }
    });
    } catch (e) {
        console.error('Ошибка в updateCardBalances:', e);
    }
}

function updateSubmitButton() {
    const submitButton = document.querySelector('.submit-button');
    if (!submitButton) return;
    
    const selectedPayment = document.querySelector('input[name="payment_method"]:checked');
    if (!selectedPayment) {
        submitButton.disabled = true;
        return;
    }
    
    const paymentMethod = selectedPayment.value;
    const totalAmount = getTotalAmount();
    let canSubmit = true;
    
    if (paymentMethod === 'sbp') {
        // СБП - всегда можно оформить
        canSubmit = true;
    } else if (paymentMethod === 'balance') {
        const balanceRadio = document.querySelector('#payment_balance');
        const balanceItem = balanceRadio ? balanceRadio.closest('.radio-item') : null;
        const balanceText = balanceItem ? balanceItem.querySelector('.radio-item-info strong')?.textContent : null;
        const balance = balanceText ? parseAmount(balanceText) : 0;
        if (balance < totalAmount) {
            canSubmit = false;
        }
    } else if (paymentMethod === 'card') {
        const savedPaymentId = selectedPayment.getAttribute('data-saved-id');
        if (savedPaymentId) {
            // Проверяем баланс сохраненной карты
            const cardItem = document.querySelector(`.radio-item[data-card-id="${savedPaymentId}"]`);
            if (cardItem) {
                const cardBalance = parseFloat(cardItem.getAttribute('data-card-balance')) || 0;
                if (cardBalance < totalAmount) {
                    canSubmit = false;
                }
            }
        } else if (selectedPayment.id === 'new_payment') {
            // Для новой карты проверяем, видна ли форма карты
            const newCardForm = document.getElementById('new-card-form');
            if (newCardForm && newCardForm.style.display !== 'none') {
                // Форма видна - проверяем заполнение полей
            const cardNumber = document.getElementById('card_number')?.value.trim();
            const cardHolderName = document.getElementById('card_holder_name')?.value.trim();
            const expiryMonth = document.getElementById('expiry_month')?.value.trim();
            const expiryYear = document.getElementById('expiry_year')?.value.trim();
            
                if (!cardNumber || !cardHolderName || !expiryMonth || !expiryYear) {
                    canSubmit = false;
                }
            }
            // Если форма скрыта - можно оформить (СБП)
        }
    }
    
    submitButton.disabled = !canSubmit;
}

// Переключение между способами оплаты
function setupPaymentMethodHandlers() {
    try {
        const paymentRadios = document.querySelectorAll('input[name="payment_method"]');
        if (!paymentRadios || paymentRadios.length === 0) return;
        
        paymentRadios.forEach(radio => {
            if (!radio) return;
            try {
                radio.addEventListener('change', function(e) {
                    try {
                        // Предотвращаем любые действия по умолчанию
                        if (e) {
                            e.preventDefault();
                            e.stopPropagation();
                        }
                        
        const newCardForm = document.getElementById('new-card-form');
                        if (!this) return;
        const paymentMethod = this.value;
                        
                        // Обновляем скрытое поле saved_payment_id
                        const savedPaymentIdInput = document.getElementById('saved_payment_id_input');
                        const savedPaymentId = this.getAttribute('data-saved-id');
                        if (savedPaymentIdInput) {
                            savedPaymentIdInput.value = savedPaymentId || '';
                        }
                        
        if (paymentMethod === 'sbp' || paymentMethod === 'balance') {
                            if (newCardForm) {
            newCardForm.style.display = 'none';
                            }
            ['card_number','card_holder_name','expiry_month','expiry_year'].forEach(id => {
                const el = document.getElementById(id);
                                if (el) {
                                    el.required = false;
                                    el.removeAttribute('required');
                                }
            });
        } else if (paymentMethod === 'card') {
            const savedPaymentId = this.getAttribute('data-saved-id');
            if (this.id === 'new_payment' || !savedPaymentId) {
                                if (newCardForm) {
                newCardForm.style.display = 'block';
                                }
                ['card_number','card_holder_name','expiry_month','expiry_year'].forEach(id => {
                    const el = document.getElementById(id);
                                    if (el) {
                                        el.required = true;
                                        el.setAttribute('required', 'required');
                                    }
                });
            } else {
                                if (newCardForm) {
                newCardForm.style.display = 'none';
                                }
                ['card_number','card_holder_name','expiry_month','expiry_year'].forEach(id => {
                    const el = document.getElementById(id);
                                    if (el) {
                                        el.required = false;
                                        el.removeAttribute('required');
                                    }
                });
            }
        }
        updateSubmitButton();
                    } catch (e) {
                        console.error('Ошибка в обработчике change для payment_method:', e);
                    }
    });
            } catch (e) {
                console.error('Ошибка при добавлении обработчика для payment_method:', e);
            }
});
    } catch (e) {
        console.error('Ошибка в setupPaymentMethodHandlers:', e);
    }
}

// Отслеживание изменений адреса
function setupAddressHandlers() {
    try {
        const addressRadios = document.querySelectorAll('input[name="address_id"]');
        if (!addressRadios || addressRadios.length === 0) return;
        
        addressRadios.forEach(radio => {
            if (!radio) return;
            try {
    radio.addEventListener('change', function() {
                    try {
        updateSubmitButton();
                    } catch (e) {
                        console.error('Ошибка в обработчике change для address_id:', e);
                    }
    });
            } catch (e) {
                console.error('Ошибка при добавлении обработчика для address_id:', e);
            }
});
    } catch (e) {
        console.error('Ошибка в setupAddressHandlers:', e);
    }
}

// Отслеживание изменений чекбокса сохранения карты
const saveCardCheckbox = document.getElementById('save_card');
if (saveCardCheckbox) {
    saveCardCheckbox.addEventListener('change', function() {
        updateSubmitButton();
    });
}

function getCookie(name) {
    let cookieValue = null;
    if(document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for(let cookie of cookies){
            cookie = cookie.trim();
            if(cookie.startsWith(name + '=')){
                cookieValue = decodeURIComponent(cookie.slice(name.length + 1));
                break;
            }
        }
    }
    if(!cookieValue){
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        if(csrfInput) cookieValue = csrfInput.value;
    }
    return cookieValue;
}

document.addEventListener('DOMContentLoaded', function() {
    // Ждем немного, чтобы все элементы точно загрузились
    setTimeout(function() {
        try {
            // Инициализация обработчиков
            setupPaymentMethodHandlers();
            setupAddressHandlers();
    
    const selectedPayment = document.querySelector('input[name="payment_method"]:checked');
            if (selectedPayment) {
                try {
                    // Не вызываем dispatchEvent, чтобы избежать ошибок
                    // Вместо этого вызываем функции напрямую
                    const newCardForm = document.getElementById('new-card-form');
                    if (newCardForm) {
                        const paymentMethod = selectedPayment.value;
                        if (paymentMethod === 'sbp' || paymentMethod === 'balance') {
                            newCardForm.style.display = 'none';
                        }
                    }
                } catch (e) {
                    console.error('Ошибка при инициализации selectedPayment:', e);
                }
            }
            
            // Проверяем наличие элементов перед вызовом функций
            const subtotalEl = document.getElementById('subtotal-value');
            const totalEl = document.getElementById('total-value');
            if (subtotalEl && totalEl) {
    calculateTotal();
    updateCardBalances();
    updateSubmitButton();
            }
            
            // Загружаем промокоды
            loadAvailablePromotions();
            
            // Инициализация обработчика формы
            try {
                const checkoutForm = document.getElementById('checkout-form');
                if (!checkoutForm) {
                    console.error('Форма checkout-form не найдена');
                } else if (!checkoutForm.hasAttribute('data-handler-initialized')) {
                    checkoutForm.setAttribute('data-handler-initialized', 'true');
                    console.log('Инициализация обработчика формы checkout-form');
                    checkoutForm.addEventListener('submit', async function(e) {
                        e.preventDefault();
                        console.log('Обработчик submit вызван');
                        
                        const selectedPayment = document.querySelector('input[name="payment_method"]:checked');
                        const submitButton = document.querySelector('.submit-button');
                        
                        if (!submitButton) {
                            alert('Ошибка: кнопка отправки не найдена');
                            console.error('Кнопка submit-button не найдена');
                            return false;
                        }
                        
                        // Проверяем баланс перед отправкой
                        const paymentMethod = selectedPayment?.value || 'sbp';
                        const totalAmount = getTotalAmount();
                        let hasEnoughFunds = true;
                        
                        if (paymentMethod === 'balance') {
                            const balanceRadio = document.querySelector('#payment_balance');
                            const balanceItem = balanceRadio ? balanceRadio.closest('.radio-item') : null;
                            const balanceText = balanceItem ? balanceItem.querySelector('.radio-item-info strong')?.textContent : null;
                            const balance = balanceText ? parseAmount(balanceText) : 0;
                            if (balance < totalAmount) {
                                hasEnoughFunds = false;
                            }
                        } else if (paymentMethod === 'card') {
                            const savedPaymentId = selectedPayment?.getAttribute('data-saved-id');
                            if (savedPaymentId) {
                                const cardItem = document.querySelector(`.radio-item[data-card-id="${savedPaymentId}"]`);
                                if (cardItem) {
                                    const cardBalance = parseFloat(cardItem.getAttribute('data-card-balance')) || 0;
                                    if (cardBalance < totalAmount) {
                                        hasEnoughFunds = false;
                                    }
                                }
                            }
                        }
                        
                        if (submitButton && submitButton.disabled && !hasEnoughFunds) {
                            alert('Недостаточно средств для оформления заказа выбранным способом оплаты.');
                            return false;
                        }
                        
                        const savedPaymentId = selectedPayment?.getAttribute('data-saved-id') || '';
                        
                        // Получаем промокод из поля ввода (если применен)
                        const promoCodeInput = document.getElementById('promo_code_input')?.value.trim().toUpperCase() || '';
                        const data = {
                            payment_method: paymentMethod
                        };
                        // Если промокод введен и применен, передаем его
                        if (promoCodeInput) {
                            data.promo_code = promoCodeInput;
                        }
                        
                        if (paymentMethod === 'card') {
                            if (savedPaymentId) {
                                // Проверяем баланс сохраненной карты перед отправкой
                                const cardItem = document.querySelector(`.radio-item[data-card-id="${savedPaymentId}"]`);
                                if (cardItem) {
                                    const cardBalance = parseFloat(cardItem.getAttribute('data-card-balance')) || 0;
                                    const totalAmount = getTotalAmount();
                                    if (cardBalance < totalAmount) {
                                        alert(`Недостаточно средств на карте. Баланс: ${cardBalance.toFixed(2)} ₽, требуется: ${totalAmount.toFixed(2)} ₽`);
                                        submitButton.disabled = false;
                                        submitButton.textContent = 'Оформить заказ';
                                        return false;
                                    }
                                }
                                data.saved_payment_id = savedPaymentId;
                            } else {
                                // Новая карта - передаем данные карты
                                const cardNumber = document.getElementById('card_number')?.value.trim() || '';
                                const cardHolderName = document.getElementById('card_holder_name')?.value.trim() || '';
                                const expiryMonth = document.getElementById('expiry_month')?.value.trim() || '';
                                const expiryYear = document.getElementById('expiry_year')?.value.trim() || '';
                                const saveCard = document.getElementById('save_card')?.checked || false;
                                
                                const newCardForm = document.getElementById('new-card-form');
                                // Если форма видна, требуем заполнения всех полей
                                if (newCardForm && newCardForm.style.display !== 'none') {
                                    if (!cardNumber || !cardHolderName || !expiryMonth || !expiryYear) {
                                        alert('Заполните все поля карты');
                                        submitButton.disabled = false;
                                        submitButton.textContent = 'Оформить заказ';
                                        return false;
                                    }
                                }
                                
                                // Передаем данные карты только если они заполнены
                                if (cardNumber && cardHolderName && expiryMonth && expiryYear) {
                                    data.card_number = cardNumber;
                                    data.card_holder_name = cardHolderName;
                                    data.expiry_month = expiryMonth;
                                    data.expiry_year = expiryYear;
                                    data.save_card = saveCard;
                                }
                            }
            } else if (paymentMethod === 'balance') {
                // Проверяем баланс пользователя
                const balanceRadio = document.querySelector('#payment_balance');
                const balanceItem = balanceRadio ? balanceRadio.closest('.radio-item') : null;
                const balanceText = balanceItem ? balanceItem.querySelector('.radio-item-info strong')?.textContent : null;
                const balance = balanceText ? parseAmount(balanceText) : 0;
                const totalAmount = getTotalAmount();
                if (balance < totalAmount) {
                    alert(`Недостаточно средств на балансе. Баланс: ${balance.toFixed(2)} ₽, требуется: ${totalAmount.toFixed(2)} ₽`);
                    submitButton.disabled = false;
                    submitButton.textContent = 'Оформить заказ';
                    return false;
                }
            }
                    
                        submitButton.disabled = true;
                        submitButton.textContent = 'Оформление...';
                        
                        const csrfToken = getCookie('csrftoken');
                        
                        try {
                            const response = await fetch('/api/orders/', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': csrfToken || ''
                                },
                                credentials: 'same-origin',
                                body: JSON.stringify(data)
                            });
                        
                            // Проверяем статус ответа перед парсингом JSON
                            if (!response.ok) {
                                const errorText = await response.text();
                                let errorData;
                                try {
                                    errorData = JSON.parse(errorText);
                                } catch {
                                    // Если это HTML (страница ошибки 500), показываем её
                                    if (response.status === 500 && (errorText.includes('<!DOCTYPE html>') || errorText.includes('<html'))) {
                                        // Логируем ошибку в консоль
                                        console.error('❌ Ошибка 500 при создании заказа');
                                        console.error('Статус:', response.status);
                                        console.error('URL:', response.url);
                                        console.error('Данные запроса:', data);
                                        console.error('Ответ сервера (HTML):', errorText.substring(0, 500) + '...');
                                        
                                        // Заменяем содержимое страницы на страницу ошибки
                                        try {
                                            // Сохраняем текущий URL для кнопки "Вернуться на главную"
                                            document.documentElement.innerHTML = errorText;
                                            
                                            // Перезапускаем скрипты после замены HTML
                                            setTimeout(function() {
                                                // Настраиваем кнопку администратора
                                                var adminButton = document.getElementById('adminButton');
                                                if (adminButton) {
                                                    adminButton.addEventListener('click', function(e) {
                                                        e.preventDefault();
                                                        e.stopPropagation();
                                                        console.log('Переход на страницу администратора');
                                                        window.location.href = '/admin-secret-check/';
                                                    });
                                                }
                                                
                                                // Используем делегирование событий для надежности
                                                document.addEventListener('click', function(e) {
                                                    if (e.target && e.target.id === 'adminButton') {
                                                        e.preventDefault();
                                                        e.stopPropagation();
                                                        window.location.href = '/admin-secret-check/';
                                                    }
                                                }, true);
                                            }, 100);
                                        } catch (e) {
                                            console.error('Ошибка при замене HTML:', e);
                                            alert('Произошла ошибка сервера. Пожалуйста, обновите страницу.');
                                        }
                                        return;
                                    }
                                    errorData = { error: errorText || 'Ошибка при оформлении заказа' };
                                }
                                
                                // Логируем ошибку в консоль
                                console.error('❌ Ошибка при создании заказа');
                                console.error('Статус:', response.status);
                                console.error('URL:', response.url);
                                console.error('Данные запроса:', data);
                                console.error('Ответ сервера:', errorData);
                                
                                const errorMsg = errorData.error || errorData.message || 'Произошла ошибка при создании заказа';
                                
                                // Если ошибка связана с недостатком средств, показываем подробное сообщение
                                if (errorMsg.includes('недостаточно') || errorMsg.includes('баланс') || errorMsg.includes('средств')) {
                                    alert(`Ошибка: ${errorMsg}`);
                                } else if (errorMsg.includes('не найден') || errorMsg.includes('целостности данных')) {
                                    // Если ошибка связана с целостностью данных, предлагаем обновить корзину
                                    if (confirm(errorMsg + '\n\nОбновить корзину и вернуться на страницу корзины?')) {
                                        window.location.href = '/cart/';
                                        return;
                                    }
                                } else {
                                    alert(`Ошибка ${response.status}: ${errorMsg}`);
                                }
                                submitButton.disabled = false;
                                submitButton.textContent = 'Оформить заказ';
                                return;
                            }
                            
                            const result = await response.json();
                            
                            console.log('🔍 Результат создания заказа:', result);
                            
                            // Пытаемся получить ID заказа из разных источников
                            let orderId = null;
                            
                            // Приоритет 1: result.order_id (прямое поле)
                            if (result.order_id) {
                                orderId = result.order_id;
                                console.log('✅ ID найден в result.order_id:', orderId);
                            }
                            // Приоритет 2: result.order.id (вложенный объект)
                            else if (result.order && result.order.id) {
                                orderId = result.order.id;
                                console.log('✅ ID найден в result.order.id:', orderId);
                            }
                            // Приоритет 3: result.id (если order это сам объект заказа)
                            else if (result.id) {
                                orderId = result.id;
                                console.log('✅ ID найден в result.id:', orderId);
                            }
                            
                            console.log('🔍 Итоговый orderId:', orderId);
                            console.log('🔍 result.success:', result.success);
                            
                            // Проверяем успешность и наличие ID
                            if (orderId) {
                                console.log(`✅ Заказ создан успешно! ID: ${orderId}`);
                                window.location.href = `/profile/orders/${orderId}/`;
                            } else if (result.success) {
                                // Если success = true, но ID не найден
                                console.error('❌ Заказ создан (success=true), но ID не найден. Результат:', result);
                                alert(`Заказ создан, но не удалось получить ID заказа.\n\nПроверьте консоль для подробностей.`);
                                submitButton.disabled = false;
                                submitButton.textContent = 'Оформить заказ';
                            } else {
                                // Если success = false или отсутствует
                                console.error('❌ Заказ не был создан успешно. Результат:', result);
                                const errorMsg = result.error || 'Неизвестная ошибка';
                                alert(`Ошибка при создании заказа: ${errorMsg}`);
                                submitButton.disabled = false;
                                submitButton.textContent = 'Оформить заказ';
                            }
                        } catch (error) {
                            console.error('❌ Ошибка при отправке запроса:', error);
                            console.error('Тип ошибки:', error.name);
                            console.error('Сообщение:', error.message);
                            console.error('Данные запроса:', data);
                            if (error.stack) {
                                console.error('Stack trace:', error.stack);
                            }
                            alert('Ошибка при отправке запроса: ' + error.message);
                            if (submitButton) {
                                submitButton.disabled = false;
                                submitButton.textContent = 'Оформить заказ';
                            }
                        }
                    });
                    console.log('Обработчик формы успешно добавлен');
                    
                    // Также добавляем обработчик на саму кнопку на случай, если форма не работает
                    const submitButton = document.querySelector('.submit-button');
                    if (submitButton && !submitButton.hasAttribute('data-handler-added')) {
                        submitButton.setAttribute('data-handler-added', 'true');
                        submitButton.addEventListener('click', function(e) {
                            // Если форма не отправилась автоматически, отправляем вручную
                            const form = document.getElementById('checkout-form');
                            if (form) {
                                const formEvent = new Event('submit', { bubbles: true, cancelable: true });
                                form.dispatchEvent(formEvent);
                            }
                        });
                    }
                }
            } catch (e) {
                console.error('Ошибка при инициализации обработчика формы:', e);
            }
        } catch (e) {
            console.error('Ошибка при инициализации DOM:', e);
        }
    }, 100);
});

    // Загрузка доступных промокодов
    function loadAvailablePromotions() {
    try {
        const loadingEl = document.getElementById('promotions-loading');
        const listEl = document.getElementById('promotions-list');
        const emptyEl = document.getElementById('promotions-empty');
        
        if (!loadingEl || !listEl || !emptyEl) {
            console.log('Элементы промокодов не найдены, пропускаем загрузку');
            return;
        }
        
        fetch('/api/available-promotions/', {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'same-origin'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (loadingEl) loadingEl.style.display = 'none';
            
            if (data.success && data.promotions && data.promotions.length > 0) {
                if (emptyEl) emptyEl.style.display = 'none';
                if (listEl) {
                    listEl.style.display = 'block';
                    listEl.innerHTML = '';
                    
                    data.promotions.forEach(promo => {
                        const isUsed = promo.is_used || false;
                        const promoCard = document.createElement('div');
                        promoCard.className = 'promo-card';
                        
                        // Стили для использованных промокодов (красные)
                        if (isUsed) {
                            promoCard.style.cssText = 'border: 1px solid var(--text-color); border-radius: 8px; padding: 16px; margin-bottom: 12px; cursor: not-allowed; transition: all 0.3s; background: #fff; opacity: 0.7;';
                        } else {
                            promoCard.style.cssText = 'border: 1px solid #ddd; border-radius: 8px; padding: 16px; margin-bottom: 12px; cursor: pointer; transition: all 0.3s; background: #fff;';
                        }
                        
                        promoCard.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="flex: 1;">
                                    <div style="font-weight: bold; font-size: 16px; color: ${isUsed ? 'var(--text-color)' : '#2c3e50'}; margin-bottom: 4px;">${promo.promo_code}</div>
                                    <div style="font-size: 14px; color: ${isUsed ? '#c0392b' : '#7f8c8d'};">
                                        ${isUsed ? 'Использован' : (promo.promo_description || 'Скидка ' + promo.discount + '%')}
                                    </div>
                                    ${promo.end_date ? '<div style="font-size: 12px; color: #95a5a6; margin-top: 4px;">Действует до: ' + new Date(promo.end_date).toLocaleDateString('ru-RU') + '</div>' : ''}
                                </div>
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div style="font-size: 18px; font-weight: bold; color: ${isUsed ? 'var(--text-color)' : 'var(--text-color)'};">-${promo.discount}%</div>
                                    ${isUsed ? 
                                        '<button type="button" disabled style="padding: 6px 12px; background: #95a5a6; color: #fff; border: none; border-radius: 4px; cursor: not-allowed; font-size: 12px; font-weight: 600; white-space: nowrap; opacity: 0.6;">Использован</button>' :
                                        '<button type="button" class="copy-promo-btn" data-promo-code="' + promo.promo_code + '" style="padding: 6px 12px; background: var(--text-color); color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600; white-space: nowrap;">Скопировать</button>'
                                    }
                                </div>
                            </div>
                        `;
                        
                        // Обработчик кнопки "Скопировать" только для неиспользованных промокодов
                        if (!isUsed) {
                            const copyBtn = promoCard.querySelector('.copy-promo-btn');
                            if (copyBtn) {
                                copyBtn.addEventListener('click', function(e) {
                                    try {
                                        if (e && e.stopPropagation) {
                                    e.stopPropagation(); // Предотвращаем всплытие события
                                        }
                                        if (!this) return;
                                    const promoCode = this.getAttribute('data-promo-code');
                                        if (!promoCode) return;
                                    const promoInput = document.getElementById('promo_code_input');
                                    if (promoInput) {
                                        promoInput.value = promoCode;
                                        // Копируем в буфер обмена
                                            if (navigator.clipboard && navigator.clipboard.writeText) {
                                        navigator.clipboard.writeText(promoCode).then(() => {
                                                    if (this) {
                                                        const originalText = this.textContent || '';
                                            this.textContent = 'Скопировано!';
                                                        if (this.style) {
                                            this.style.background = 'var(--btn-bg)';
                                                        }
                                            setTimeout(() => {
                                                            if (this) {
                                                this.textContent = originalText;
                                                                if (this.style) {
                                                this.style.background = 'var(--text-color)';
                                                                }
                                                            }
                                            }, 2000);
                                                    }
                                        }).catch(() => {
                                            // Если не удалось скопировать, просто заполняем поле
                                                    if (promoInput && promoInput.select) {
                                            promoInput.select();
                                                        if (promoInput.setSelectionRange) {
                                            promoInput.setSelectionRange(0, 99999);
                                                        }
                                                    }
                                        });
                                            }
                                    }
                                    } catch (err) {
                                        console.error('Ошибка в обработчике кнопки "Скопировать":', err);
                                    }
                                });
                            }
                        }
                        
                        listEl.appendChild(promoCard);
                    });
                }
            } else {
                if (listEl) listEl.style.display = 'none';
                if (emptyEl) emptyEl.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Ошибка при загрузке промокодов:', error);
            if (loadingEl) loadingEl.style.display = 'none';
            if (listEl) listEl.style.display = 'none';
            if (emptyEl) {
                emptyEl.style.display = 'block';
                emptyEl.textContent = 'Ошибка при загрузке промокодов';
            }
        });
    } catch (e) {
        console.error('Ошибка в loadAvailablePromotions:', e);
    }
    }
    
    // Применение промокода
    function applyPromoCode(promoCode) {
        try {
        const message = document.getElementById('promo_message');
            const subtotalEl = document.getElementById('subtotal-value');
            if (!subtotalEl) return;
            const cartTotal = parseFloat((subtotalEl.textContent || '0').replace(/\s/g, '').replace('₽', '')) || 0;
        
        if (!promoCode || !promoCode.trim()) {
            if (message) {
                message.textContent = 'Введите промокод';
                message.style.color = 'var(--text-color)';
                message.style.display = 'block';
            }
            return;
        }
        
        fetch('/api/validate-promo/', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'same-origin',
            body: JSON.stringify({
                promo_code: promoCode.toUpperCase().trim(),
                cart_total: cartTotal
            })
        })
        .then(r => {
            if (!r.ok) {
                return r.json().then(data => {
                    throw new Error(data.error || 'Ошибка проверки промокода');
                });
            }
            return r.json();
        })
        .then(data => {
            if (data.success) {
                const discountItem = document.getElementById('discount-item');
                const discountValue = document.getElementById('discount-value');
                const vatValue = document.getElementById('vat-value');
                const totalValue = document.getElementById('total-value');
                if (discountItem) discountItem.style.display = 'flex';
                if (discountValue) discountValue.textContent = formatAmount(parseFloat(data.discount));
                if (vatValue) vatValue.textContent = formatAmount(parseFloat(data.vat_amount));
                if (totalValue) totalValue.textContent = formatAmount(parseFloat(data.total));
                if (message) {
                    message.textContent = 'Промокод применен (' + data.discount_percent + '%)';
                    message.style.color = 'var(--text-color)';
                    message.style.display = 'block';
                }
                // Доставка для онлайн-курсов не используется — не перезаписываем «Не требуется»
                updateSubmitButton();
            } else {
                if (message) {
                    message.textContent = data.error || 'Промокод не принят';
                    message.style.color = 'var(--text-color)';
                    message.style.display = 'block';
                }
            }
        })
        .catch(error => {
            if (message) {
                message.textContent = error.message || 'Ошибка проверки промокода';
                message.style.color = 'var(--text-color)';
                message.style.display = 'block';
            }
        });
        } catch (e) {
            console.error('Ошибка в applyPromoCode:', e);
        }
    }
    
    // Обработчик кнопки "Применить" для промокода
    const applyPromoBtn = document.getElementById('apply_promo_btn');
    const promoCodeInput = document.getElementById('promo_code_input');
    if (applyPromoBtn && promoCodeInput) {
        applyPromoBtn.addEventListener('click', function() {
            const promoCode = promoCodeInput.value.trim().toUpperCase();
            if (!promoCode) {
                const message = document.getElementById('promo_message');
                if (message) {
                    message.textContent = 'Введите промокод';
                    message.style.color = 'var(--text-color)';
                    message.style.display = 'block';
                }
                return;
            }
            applyPromoCode(promoCode);
        });
        
        // Применение по Enter
        promoCodeInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                applyPromoBtn.click();
            }
        });
    }
    

// Тест: проверяем, что кнопка и форма работают
setTimeout(function() {
    const form = document.getElementById('checkout-form');
    const button = document.querySelector('.submit-button');
    console.log('Проверка формы и кнопки:');
    console.log('- Форма найдена:', !!form);
    console.log('- Кнопка найдена:', !!button);
    console.log('- Кнопка disabled:', button ? button.disabled : 'N/A');
    console.log('- Обработчики формы:', form ? form.getAttribute('data-handler-initialized') || form.getAttribute('data-backup-handler') : 'N/A');
}, 1000);
 
// Форматирование полей карты
['card_number'].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
        el.addEventListener('input', function(e) {
            let v = e.target.value.replace(/\s/g, '');
            e.target.value = (v.match(/.{1,4}/g)?.join(' ') || v);
        });
    }
});

['expiry_month'].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
        el.addEventListener('input', function(e) {
            let v = e.target.value.replace(/\D/g, '');
            if (v.length > 2) v = v.slice(0, 2);
            if (v.length === 2 && parseInt(v) > 12) v = '12';
            e.target.value = v;
        });
    }
});

['expiry_year'].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
        el.addEventListener('input', function(e) {
            let v = e.target.value.replace(/\D/g, '');
            if (v.length > 4) v = v.slice(0, 4);
            e.target.value = v;
        });
    }
});
</script>
{% endblock %}




