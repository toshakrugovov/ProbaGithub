{% extends 'base.html' %}
{% load static %}
{% load course_media %}

{% block title %}{{ course.title }} - MPTCOURSE{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/home.css' %}">
<link rel="stylesheet" href="{% static 'css/profile.css' %}">
<link rel="stylesheet" href="{% static 'css/catalog.css' %}">
<style>
.course-view-header { margin-bottom: 24px; }
.course-view-header h1 { font-size: 24px; margin-bottom: 8px; }
.course-view-header a { color: var(--text-color); text-decoration: none; font-size: 14px; }
.course-view-header a:hover { text-decoration: underline; }
.content-list { display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 32px; }
.content-page-btn {
    display: inline-flex; align-items: center; gap: 8px;
    padding: 12px 16px; background: var(--bg-color); border: 1px solid #000;
    border-radius: 8px; cursor: pointer; color: inherit; font-size: 14px;
}
.content-page-btn:hover { background: var(--border-color); }
.content-page-btn.viewed { opacity: 0.8; }
.course-end-section { margin-top: 32px; padding: 24px; border: 1px solid var(--border-color); border-radius: 12px; }
.course-end-section h3 { margin-bottom: 16px; font-size: 18px; }
.course-modal-content { max-width: 90vw; max-height: 85vh; overflow: auto; }
.course-modal-content iframe { width: 100%; min-height: 400px; border: 0; }
.stars-rating { display: flex; gap: 4px; cursor: pointer; margin-bottom: 12px; }
.stars-rating .star { font-size: 24px; color: var(--border-color); }
.stars-rating .star.active { color: var(--text-color, #1a1a1a); }
</style>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/pdf-viewer.js' %}"></script>
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="profile-content">
    <div class="orders-content" style="max-width: 900px;">
        <div class="course-view-header">
            <h1>{{ course.title }}</h1>
            <a href="{% url 'my_courses' %}">← Мои курсы</a>
        </div>

        <p style="margin-bottom: 20px;">Контент курса (откройте каждый блок):</p>
        <div class="content-list">
            {% for page in content_pages %}
            <button type="button" class="content-page-btn {% if page.id in viewed_page_ids %}viewed{% endif %}"
                    data-page-id="{{ page.id }}"
                    data-content-type="{{ page.content_type }}"
                    data-file-path="{{ page.file_path|escapejs }}"
                    data-serve-path="{% if page.file_path|is_local_course_media %}{{ page.file_path|course_media_path }}{% endif %}"
                    data-page-number="{{ page.page_number|default:1 }}"
                    data-title="{{ page.title|default:page.get_content_type_display }}">
                {{ page.title|default:page.get_content_type_display }}{% if page.id in viewed_page_ids %} ✓{% endif %}
            </button>
            {% empty %}
            <p>В курсе пока нет страниц контента.</p>
            {% endfor %}
        </div>

        {% if not content_pages %}
        <div class="course-end-section">
            <p>Курс пока не содержит материалов.</p>
        </div>
        {% endif %}

        {% if content_pages and not has_survey %}
        <div class="course-end-section" id="survey-section">
            <h3>Опрос (оценка курса по 5 баллам)</h3>
            <div class="stars-rating" id="survey-stars">
                <span class="star" data-rating="1">★</span>
                <span class="star" data-rating="2">★</span>
                <span class="star" data-rating="3">★</span>
                <span class="star" data-rating="4">★</span>
                <span class="star" data-rating="5">★</span>
            </div>
            <input type="hidden" id="survey-rating" value="0">
            <button type="button" class="btn btn-primary" id="survey-submit" disabled>Отправить оценку</button>
        </div>
        {% endif %}

        {% if content_pages and has_survey and not has_review %}
        <div class="course-end-section" id="review-section">
            <h3>Отзыв о курсе</h3>
            <div class="stars-rating" id="review-stars">
                <span class="star" data-rating="1">★</span>
                <span class="star" data-rating="2">★</span>
                <span class="star" data-rating="3">★</span>
                <span class="star" data-rating="4">★</span>
                <span class="star" data-rating="5">★</span>
            </div>
            <input type="hidden" id="review-rating" value="0">
            <div class="form-group" style="margin-top: 12px;">
                <label for="review-text">Текст отзыва (необязательно)</label>
                <textarea id="review-text" rows="3" style="width: 100%; padding: 8px;"></textarea>
            </div>
            <button type="button" class="btn btn-primary" id="review-submit" disabled>Отправить отзыв</button>
        </div>
        {% endif %}

        {% if can_archive or purchase.completed_at %}
        <div class="course-end-section">
            <p><strong>Курс завершён.</strong> {% if purchase.completed_at %}Переведён в архив {{ purchase.completed_at|date:"d.m.Y" }}.{% endif %}</p>
            <a href="{% url 'my_courses' %}" class="btn btn-primary">Вернуться к моим курсам</a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Модальное окно контента -->
<div id="contentModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 900px;">
        <span class="modal-close" id="contentModalClose">&times;</span>
        <h3 id="contentModalTitle"></h3>
        <div class="course-modal-content" id="contentModalBody"></div>
    </div>
</div>

<script>
(function() {
    const purchaseId = {{ purchase.id }};
    const serveMediaUrl = "{% url 'serve_course_media' purchase_id=purchase.id %}";
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    function getCookie(name) {
        let v = null;
        if (document.cookie) {
            document.cookie.split(';').forEach(function(c) {
                c = c.trim();
                if (c.startsWith(name + '=')) v = decodeURIComponent(c.slice(name.length + 1));
            });
        }
        return v || csrfToken;
    }

    document.querySelectorAll('.content-page-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const pageId = this.dataset.pageId;
            const contentType = this.dataset.contentType;
            const filePath = this.dataset.filePath;
            const pageNumber = parseInt(this.dataset.pageNumber, 10) || 1;
            const title = this.dataset.title || 'Контент';

            fetch('{% url "course_content_view_record" purchase_id=purchase.id %}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
                body: JSON.stringify({ content_page_id: parseInt(pageId, 10) }),
                credentials: 'same-origin'
            }).then(function(r) { return r.json(); }).catch(function() {});

            var body = document.getElementById('contentModalBody');
            document.getElementById('contentModalTitle').textContent = title;

            if (contentType === 'youtube') {
                var url = filePath;
                var vid = url.match(/(?:v=|\/)([a-zA-Z0-9_-]{11})/);
                if (vid) url = 'https://www.youtube.com/embed/' + vid[1];
                body.innerHTML = '<iframe src="' + url + '" allowfullscreen></iframe>';
            } else if (contentType === 'rutube') {
                body.innerHTML = '<p style="margin-bottom:12px;">Rutube не поддерживает встраивание в окне курса.</p><p><a href="' + (filePath || '').replace(/"/g, '&quot;') + '" target="_blank" rel="noopener noreferrer" class="btn btn-primary">Открыть видео на Rutube</a></p>';
            } else if (contentType === 'pdf_page') {
                var pdfUrl;
                if (this.dataset.servePath) {
                    pdfUrl = serveMediaUrl + '?path=' + encodeURIComponent(this.dataset.servePath);
                } else {
                    pdfUrl = filePath.indexOf('#') >= 0 ? filePath.split('#')[0] : filePath;
                }
                body.innerHTML = '<div class="pdf-viewer-container" data-pdf-url="' + (pdfUrl || '').replace(/"/g, '&quot;') + '" data-pdf-page="' + (pageNumber || 1) + '"></div>';
                if (window.renderOnePdfViewer) window.renderOnePdfViewer(body.querySelector('.pdf-viewer-container'));
            } else {
                body.innerHTML = '<p>Файл: <a href="' + filePath + '" target="_blank" rel="noopener">Открыть</a></p>';
            }

            document.getElementById('contentModal').style.display = 'flex';
            btn.classList.add('viewed');
            if (!btn.textContent.includes('✓')) btn.textContent = (btn.textContent || '').trim() + ' ✓';
        });
    });

    document.getElementById('contentModalClose').addEventListener('click', function() {
        document.getElementById('contentModal').style.display = 'none';
    });

    // Survey
    var surveyStars = document.getElementById('survey-stars');
    if (surveyStars) {
        var surveyRating = document.getElementById('survey-rating');
        var surveySubmit = document.getElementById('survey-submit');
        surveyStars.querySelectorAll('.star').forEach(function(star) {
            star.addEventListener('click', function() {
                var r = parseInt(this.dataset.rating, 10);
                surveyRating.value = r;
                surveyStars.querySelectorAll('.star').forEach(function(s, i) {
                    s.classList.toggle('active', i < r);
                });
                surveySubmit.disabled = false;
            });
        });
        surveySubmit.addEventListener('click', function() {
            var r = parseInt(surveyRating.value, 10);
            if (r < 1 || r > 5) return;
            fetch('{% url "course_survey_submit" purchase_id=purchase.id %}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
                body: JSON.stringify({ rating: r }),
                credentials: 'same-origin'
            }).then(function(res) { return res.json(); }).then(function(data) {
                if (data.success) location.reload();
            });
        });
    }

    // Review
    var reviewStars = document.getElementById('review-stars');
    if (reviewStars) {
        var reviewRating = document.getElementById('review-rating');
        var reviewSubmit = document.getElementById('review-submit');
        reviewStars.querySelectorAll('.star').forEach(function(star) {
            star.addEventListener('click', function() {
                var r = parseInt(this.dataset.rating, 10);
                reviewRating.value = r;
                reviewStars.querySelectorAll('.star').forEach(function(s, i) {
                    s.classList.toggle('active', i < r);
                });
                reviewSubmit.disabled = false;
            });
        });
        reviewSubmit.addEventListener('click', function() {
            var r = parseInt(reviewRating.value, 10);
            if (r < 1 || r > 5) return;
            var text = (document.getElementById('review-text') && document.getElementById('review-text').value) || '';
            fetch('{% url "course_review_submit" purchase_id=purchase.id %}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
                body: JSON.stringify({ rating: r, text: text }),
                credentials: 'same-origin'
            }).then(function(res) { return res.json(); }).then(function(data) {
                if (data.success) location.reload();
            });
        });
    }
})();
</script>
{% endblock %}
