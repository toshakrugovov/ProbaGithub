# Бизнес-логика MPTCOURSE

## 1. Каталог курсов
- В каталоге отображаются **курсы** (товары = курсы).
- **Категории** задаются при добавлении/редактировании курса (поле категории у курса).
- Фильтрация по категории и поиск по названию/описанию.

## 2. Корзина → Оформление заказа
1. Пользователь добавляет курсы в **корзину**.
2. Переход к **оформлению заказа** (checkout).
3. Выбор **способа оплаты**: **карта** или **СБП** (и при необходимости оплата с баланса).
4. При наличии — ввод и **применение промокода**.
5. **Оформить заказ** → создаётся заказ (order), платёж (payment), при успехе — **чек** (receipt).

## 3. Чеки
- После успешной оплаты заказа формируется **чек** (receipt + receiptitem с названиями курсов).
- Чеки доступны в профиле (список чеков, скачать PDF при необходимости).

## 4. Профиль → «Мои курсы»
- В профиле пользователя вкладка **«Мои курсы»**: список **купленных** курсов (по `course_purchase` со статусом `paid`).
- Разделение:
  - **Актуальные** — курсы, которые ещё не переведены в архив (`course_purchase.completed_at IS NULL`).
  - **Архивные** — курсы, переведённые в архив (`course_purchase.completed_at IS NOT NULL`).

## 5. Когда курс попадает в архив (обязательно)
Курс считается **архивным** только после выполнения **всех** условий:
1. Пользователь **долистал до конца** весь курс (все страницы контента отмечены как просмотренные в `course_content_view`).
2. Пользователь **прошёл опрос** в конце курса (5-балльная шкала) — запись в `course_survey`.
3. Пользователь **написал отзыв** — запись в `course_review`.

После выполнения всех трёх условий выставляется `course_purchase.completed_at` — курс переходит в «Архивные».

## 6. Прохождение (просмотр) курса
- Из «Мои курсы» по нажатию на курс открывается **прохождение курса**.
- Контент курса — страницы из `course_content_page` (каждая запись = отдельное модальное окно):
  - **pdf_page** — страница PDF;
  - **youtube** — ссылка на YouTube (видео отображается в курсе как видео);
  - **rutube** — ссылка на Rutube;
  - **pptx_slide** — презентация PowerPoint;
  - **docx** — документ Word;
  - **video** — видео (файл).
  Для YouTube/Rutube в `file_path` хранится ссылка; в купленном курсе видео показывается как плеер.
- При открытии страницы создаётся запись в `course_content_view` (учёт «долистал до конца»).
- В **конце курса** показываются:
  1. **Опросник** (5-балльная шкала) → сохранение в `course_survey`.
  2. **Форма отзыва** (текст + оценка 1–5) → сохранение в `course_review`.
- После отправки опроса и отзыва проверяется условие архивации; если все страницы просмотрены — выставляется `completed_at`.

## 7. Способы оплаты
- **card** — банковская карта.
- **sbp** — СБП.
- **balance** — оплата с личного баланса (при наличии).

## 8. Таблицы БД (кратко)
| Таблица | Назначение |
|--------|------------|
| course_category | Категории курсов (задаются при добавлении курса) |
| course | Курсы |
| course_content_page | Состав курса: страница PDF, YouTube, Rutube, PowerPoint, Word (docx). Каждая запись = одно модальное окно; в купленном курсе видео отображается как видео. |
| course_purchase | Покупка доступа к курсу; completed_at = в архиве |
| course_content_view | Факт просмотра страницы (для учёта «до конца») |
| course_survey | Опрос в конце курса (5 баллов) |
| course_review | Отзыв о курсе |
| cart / cartitem | Корзина (курсы) |
| order / orderitem | Заказ (курсы) |
| payment | Платёж по заказу |
| receipt / receiptitem | Чек по заказу |
